DM相談機能：要件定義（Claude Code用構造化版）
ユーザーの相談開始フロー
#### 一般ユーザー

パターンA：一覧から開始

  
メニュー > イメージコンサルタントにDM相談 > 一覧表示 > チャットアイコンをタップ

パターンB：プロフィールから開始

  
コンサルタントのプロフィール画面 > 「DMで相談する」をタップ

#### 共通遷移

「チケットを購入する」「チケットコードを入力する」2つの選択肢を表示

有料チケット関連の処理
#### チケット購入（通常）

「チケットを購入する」ボタンでStripe決済画面へ遷移
決済完了後：

  
コンサルタントとのDMチャット画面に遷移
コンサルタント一覧画面では「担当イメコン」として表示
承認されるまではチャット送信不可（下記制限状態）

#### 承認待ち状態のUI

チャット画面上部に以下を表示：

  
「現在コンサルタントの承認待ちです」
「承認されるまでメッセージや写真の送信はできません」
「3日以内に承認されない場合、料金の引き落としはキャンセルされます」
送信ボタンは無効化（グレーアウト）
ユーザーによるキャンセルで料金はキャンセル
72時間経過で自動キャンセル

#### チケットコード入力

「チケットコードを入力する」ボタン > 入力欄表示 > 入力後チャット画面へ遷移
同様に「担当イメコン」として一覧に反映

コンサルタント側の対応
#### 受付設定

プロフィール設定：「有料DM相談を受け付ける」フラグあり（初期状態：いいえ）
「はい」の場合：ユーザーがチケット購入可能に
「いいえ」の場合：

  
購入ボタン無効化（押せない）
「チケット購入からの相談は現在お受けしておりません」と表示

#### 承認プロセス

通知・メッセージ一覧に「DM相談の依頼が来ています」が表示
該当行をタップ > ポップアップ表示：「相談依頼を承認しますか？」 > 「はい」「いいえ」

##### 「はい」を選択した場合：

チャットが通常利用可能になる（両者とも）

##### 「いいえ」を選択した場合：

ユーザー画面に：

  
「申し訳ありませんが、現在相談を受けることができません」
「料金の引き落としはキャンセルさせて頂きました」
送信ボタンはグレーアウトのまま

##### 無応答（72時間経過）：

自動的に「いいえ」を押した時と同じ挙動を実行
チャットは初期状態に戻る

相談期間終了後
開始から168時間（1週間）後：

  
チャットフッターに「相談期間は終了しました」と表示
送信ボタンはグレーアウト
チャット履歴は閲覧可能

---

この構成により、UI/UXの分岐処理、条件分岐、遷移制御がClaude Codeで明確にロジック実装できるよう整理されています。